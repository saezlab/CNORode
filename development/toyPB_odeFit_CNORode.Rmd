---
title: "toy model PB ODE formalism"
author: "Attila Gabor"
date: "22 June 2018"
output: html_document
---

Summary:

- we wanted to reproduce the State-time spectrum paper results. 
- put PKN_TRUE and MIDAS together. 
- added the parameters from the supp material. 
- model fails to fit GSK3 and NFKB.

Reason:
- initial state looks like 0.1 (hard coded in C)
- when inhibitor is on, the corresponsding node is set to 0.1 too!
- dont get fooled by the interface of the R code, the C-code does not accept initial_state...
- missfit of GSK3:  When PI3K is inhibited, its value is set to 0.1 (why not 0?),
	this leads to a small activation of AKT, and that will inhibit GSK3. 




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Liver Dream example using Boolean formalism

Checking if the PKN can be fitted to the data. 

```{r package-loading }
#suppressMessages(library(CellNOptR))
#suppressMessages(library(MEIGOR))
# install_github("saezlab/CNORode")
suppressMessages(library(CNORode))
```



```{r importModels}
cnodata = CNOlist("data/ToyModel_PB/ToyModelPB.csv")
pkn_paper= readSIF("data/ToyModel_PB/PKN-ToyPB.sif")
pkn_dataGen= readSIF("data/ToyModel_PB/ToyModelPB_TRUE.sif")
plotModel(pkn_paper,cnodata)
```
this is very similar to Fig.1. of  
MacNamara et al. 2012, Stateâ€“time spectrum of signal transduction logic models   
(http://iopscience.iop.org/article/10.1088/1478-3975/9/4/045003)  
but missing node ASK-1: therefore TNFa signalng cannot reach AP-1 without going through PI3K.  

Therefore this model will not fit perfectly the data.  

The TRUE model found in cellnopt.org:
```{r}
plotModel(pkn_dataGen,cnodata)
```

This looks like the model that generated the data. 
- ask1 is included and it is connecting traf2 to mkk7. 
- in the paper it was written that ask1 should be connected to map3k7,
therefore I added this edge manually to the PKN. But this looks incorrect: traf2 -> ask1 -> map3k7  cannot be distinguished from traf2 -> map3k7. This looks totally redundant, so I eliminated the edge ask1 -> map3k7
- TNFR -> PI3K, PI3K -> Rac, and  Rac -> Map3K1 are not aprt of the PKN. 


### Compression -- not needed for CNORode model
we want to avoid the compression of feedback loops (ph and ex). The reason is not 
totally clear, but this is how they did in the MacNamara paper. 

We import a new CNOlist in which the nodes: ex, ph, sos and ikb are measured. 
This is only used for compression of the model network. 

```{R}
# cnodata_compress = CNOlist("data/ToyModel_PB/ToyModelPB_4compression.csv")
model = preprocessing(cnodata,pkn_dataGen,expansion = F, compression = F)
#rm(cnodata_compress)

plotModel(model,cnodata)

```

```{r setupOptim}
ode_parameters=createLBodeContPars(model, LB_n = 1, LB_k = 0,
								   LB_tau = 0, UB_n = 5, UB_k = 5, UB_tau = 10, default_n = 3,
								   default_k = 0.5, default_tau = 0.01, opt_n = TRUE, opt_k = TRUE,
								   opt_tau = TRUE, random = TRUE)
```

```{r}
init_param = c("map3k7_n_nik"=1,
			   "map3k7_k_nik"=0.0905,
			   "tau_nik"=7.1398,
			   "map3k7_n_mkk4"=1.09,
			   "map3k7_k_mkk4"=0.95,
			   "map3k1_n_mkk4"=3.1526,
			   "map3k1_k_mkk4"=0.4721,
			   "tau_mkk4"=5.4167,
			   "traf2_n_ask1"=3.4873,
			   "traf2_k_ask1"=0.15,
			   "tau_ask1"=5.2731,
			   "traf2_n_map3k7"=1,
			   "traf2_k_map3k7"=0.0918,
			   "tau_map3k7"=0.1,
			   "ask1_n_mkk7"=3.5966,
			   "ask1_k_mkk7"=0.7772,
			   "map3k1_n_mkk7"=3.9788,
			   "map3k1_k_mkk7"=0.4026,
			   "tau_mkk7"=10,
			   "tnfa_n_tnfr"=1.0188,
			   "tnfa_k_tnfr"=0.1173,
			   "tau_tnfr"=9.1369,
			   "egf_n_egfr"=4.892,
			   "egf_k_egfr"=0.0905,
			   "tau_egfr"=1.0937,
			   "erk_n_ph"=4.611,
			   "erk_k_ph"=0.1027,
			   "tau_ph"=0.106,
			   "nfkb_n_ex"=4.9909,
			   "nfkb_k_ex"=0.4268,
			   "tau_ex"=0.6146,
			   "raf1_n_mek"=1.4875,
			   "raf1_k_mek"=0.5195,
			   "tau_mek"=9.5228,
			   "sos_n_ras"=1.454,
			   "sos_k_ras"=0.7119,
			   "tau_ras"=2.8385,
			   "tnfr_n_traf2"=4.1622,
			   "tnfr_k_traf2"=0.5476,
			   "tau_traf2"=9.9362,
			   "nik_n_ikk"=4.997,
			   "nik_k_ikk"=0.1029,
			   "tau_ikk"=5.7463,
			   "pi3k_n_akt"=1.0726,
			   "pi3k_k_akt"=0.9486,
			   "tau_akt"=9.5917,
			   "egfr_n_pi3k"=4.4151,
			   "egfr_k_pi3k"=0.0944,
			   "tau_pi3k"=7.7292,
			   "ex_n_ikb"=4.9991,
			   "ex_k_ikb"=0.6852,
			   "ikk_n_ikb"=1.5451,
			   "ikk_k_ikb"=0.95,
			   "tau_ikb"=0.6778,
			   "ikb_n_nfkb"=4.9997,
			   "ikb_k_nfkb"=0.2329,
			   "tau_nfkb"=0.9984,
			   "jnk_n_cjun"=1.0759,
			   "jnk_k_cjun"=0.9496,
			   "tau_cjun"=9.6513,
			   "mkk7_n_jnk"=4.8747,
			   "mkk7_k_jnk"=0.0913,
			   "tau_jnk"=1.3215,
			   "ras_n_map3k1"=1.1997,
			   "ras_k_map3k1"=0.8298,
			   "tau_map3k1"=9.995,
			   "mek_n_erk"=2.5354,
			   "mek_k_erk"=0.7099,
			   "tau_erk"=10,
			   "ras_n_raf1"=1,
			   "ras_k_raf1"=0.2725,
			   "tau_raf1"=0.8552,
			   "egfr_n_sos"=1.0012,
			   "egfr_k_sos"=0.9375,
			   "ph_n_sos"=1.4651,
			   "ph_k_sos"=0.72,
			   "tau_sos"=9.3196,
			   "mkk4_n_p38"=1.0032,
			   "mkk4_k_p38"=0.9329,
			   "tau_p38"=0.1,
			   "akt_n_gsk3"=1.0608,
			   "akt_k_gsk3"=0.09,
			   "tau_gsk3"=0.2602,
			   "cjun_n_ap1"=4.7985,
			   "cjun_k_ap1"=0.2653,
			   "tau_ap1"=0.2045)
```

```{r}
parMatchID = match(ode_parameters$parNames, names(init_param))
# match(names(init_param),ode_parameters$parNames) 
if(any(is.na(parMatchID))) stop(" some parameters were not matched in the initial parameter set")



if(!all(ode_parameters$parNames == names(init_param)[parMatchID])) stop("some parametes were not found")

ode_parameters$parValues = init_param[parMatchID]

```
Simulate the initial parameter vector
```{r, fig.height=14, fig.width=14}
simulatedData=plotLBodeFitness(cnodata, model, transfer_function=3, ode_parameters=ode_parameters, reltol = 1e-6, atol = 1e-3, maxStepSize = 0.001)

```
GSK3B drops, when we have PI3K inhibitor:
- is it the problem of initial condition? 

```{r, fig.height=14, fig.width=14}
cnodata_initCond = CNOlist("data/ToyModel_PB/ToyModelPB_initCond.csv")
plot(cnodata_initCond)
simulatedData=plotLBodeFitness(cnodata_initCond, model, transfer_function=3, ode_parameters=ode_parameters, reltol = 1e-6, atol = 1e-3, maxStepSize = 0.001)
```



```{r simData, fig.height=14, fig.width=14}
# indices <- indexFinder(cnodata, model, verbose = FALSE)
# indices$signals = setdiff(1:length(model$namesSpecies), indices$stimulated) 
sim_data = getLBodeDataSim(cnolist = cnodata,model =  model,verbose = T,initial_state = 0.0,
						   transfer_function=3, ode_parameters=ode_parameters, reltol = 1e-6, atol = 1e-3, maxStepSize = 0.001)
plotOptimResultsPan(sim_data, yInterpol = NULL, xCoords = NULL, 
					CNOlist = cnodata, formalism = "ode", pdf = FALSE, tPt = NULL)


```
```{r sim_model,fig.height=14, fig.width=14}


cnolist = compatCNOlist(cnodata)
adjMat = incidence2Adjacency(model)
indices <- indexFinder(cnodata, model, verbose = FALSE)

sim_function = getLBodeSimFunction(cnolist1=cnolist, model1=model, adjMatrix1 =adjMat,
								   indices1=indices, odeParameters1 =ode_parameters, 
								   time1 = 1, verbose1 = T, transfer_function1=3, reltol1= 1e-6, atol1= 1e-3, 
								   maxStepSize1 =0.001 ,)
sim_model = sim_function(cnolist = cnolist, sif = model, odeParameters = ode_parameters$parValues)
plotLBodeModelSim(simResults = sim_model, yInterpol = NULL, xCoords = NULL, 
					CNOlist =cnodata , formalism = "ode", pdf = FALSE, tPt = NULL)

```
```{r}
# sets optimisation parameters to default values
paramsSSm=defaultParametersSSm()
paramsSSm$transfer_function=3

paramsSSm$local_solver = "DHC"
paramsSSm$maxtime = 30;
paramsSSm$maxeval = Inf;
paramsSSm$atol=1e-6;
paramsSSm$reltol=1e-6;
paramsSSm$nan_fac=10;
paramsSSm$dim_refset=30;
paramsSSm$n_diverse=100;
paramsSSm$maxStepSize=0.5;
paramsSSm$maxNumSteps=10000;
```



```{r optimisation}
# passed to parameter estimation function as follows
opt_pars=parEstimationLBode(cnodata,model, method="essm", ode_parameters=ode_parameters, paramsSSm=paramsSSm)
```

```{r plotAndSave, fig.height=14, fig.width=14}
#simulatedData=plotLBodeFitness(cnolist, model, transfer_function=4, ode_parameters=opt_pars)

simulatedData=plotLBodeFitness(cnodata, model, transfer_function=3, ode_parameters=opt_pars, reltol = 1e-6, atol = 1e-6, maxStepSize = 1)



saveRDS(ode_parameters,file = "output/liverDREAM_ode/ode_parameters.RDS")
saveRDS(paramsSSm,file = "output/liverDREAM_ode/paramsSSm.RDS")
saveRDS(opt_pars,file = "output/liverDREAM_ode/opt_pars.RDS")
```


